name: Helm Validate

on:
  workflow_call:
    inputs:
      chart_path:
        description: 'Path to the chart directory'
        type: string
        default: '.'
      helm_docs_version:
        description: 'Helm-docs version'
        type: string
        default: 'v1.14.2'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup yq
        uses: mikefarah/yq@master

      - name: Check version bump
        working-directory: ${{ inputs.chart_path }}
        run: |
          git fetch origin main

          PR_VERSION=$(yq '.version' Chart.yaml)
          MAIN_VERSION=$(git show origin/main:${{ inputs.chart_path }}/Chart.yaml 2>/dev/null | yq '.version' || echo "0.0.0")

          echo "PR version:   $PR_VERSION"
          echo "Main version: $MAIN_VERSION"

          HIGHEST=$(printf '%s\n' "$PR_VERSION" "$MAIN_VERSION" | sort -V | tail -n 1)
          if [ "$HIGHEST" = "$MAIN_VERSION" ]; then
            echo "::error::Chart version in PR ($PR_VERSION) must be greater than in main ($MAIN_VERSION). Please bump the version in Chart.yaml"
            exit 1
          fi

          echo "Version check passed: $PR_VERSION > $MAIN_VERSION"

      - name: Check docs
        working-directory: ${{ inputs.chart_path }}
        run: |
          VERSION="${{ inputs.helm_docs_version }}"
          curl -sL "https://github.com/norwoodj/helm-docs/releases/download/${VERSION}/helm-docs_${VERSION#v}_Linux_x86_64.tar.gz" | tar xz helm-docs

          ./helm-docs --template-files=README.md.gotmpl

          if ! git diff --quiet README.md; then
            echo "::error::README.md is out of date. Please run 'helm-docs --template-files=README.md.gotmpl' and commit the result"
            git diff README.md
            exit 1
          fi
